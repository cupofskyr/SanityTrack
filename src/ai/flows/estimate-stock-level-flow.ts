
'use server';
/**
 * @fileOverview An AI flow for estimating stock levels from a camera image using few-shot prompting.
 *
 * - estimateStockLevel - A function that analyzes an image to determine stock levels.
 * - EstimateStockLevelInput - The input type for the function.
 * - EstimateStockLevelOutput - The return type for the function.
 */

import { ai } from '@/ai/genkit';
import {
    EstimateStockLevelInputSchema,
    type EstimateStockLevelInput,
    EstimateStockLevelOutputSchema,
    type EstimateStockLevelOutput
} from '@/ai/schemas/stock-level-schemas';

// For simplicity in this example, we'll embed the images as data URIs.
// In a real app, you might fetch these from a database or storage bucket.
const fullStockUri = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAEYCAYAAADw5sJwAAABN0lEQVR4nO3BMQEAAADCoPVPbQwfoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAODZAbJgAAGeKO3OAAAAAElFTkSuQmCC'; // Placeholder grey image
const lowStockUri = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAEYCAYAAADw5sJwAAAA60lEQVR4nO3UAQ0AMAjAsKM78OgA/x9I0AElzR2b8/MFAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAN2OFY/gH/9E3AAAAAElFTkSuQmCC'; // Placeholder grey image with some alpha
const criticalStockUri = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAARgAAAEYCAYAAADw5sJwAAAChUlEQVR4nO3UAQkAMAjAsKM78OgAPg9I0AElTW1/AgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwK98wAEDAAD80gYAAHyHBAAAAgQIAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQAAQIECAAECAgQ-wgFdpwAB45m1MAAAAABJRU5ErkJggg=='; // Placeholder almost empty

export async function estimateStockLevel(input: EstimateStockLevelInput): Promise<EstimateStockLevelOutput> {
  return estimateStockLevelFlow(input);
}

const prompt = ai.definePrompt({
    name: 'estimateStockLevelPrompt',
    model: 'googleai/gemini-1.5-flash-latest',
    input: { schema: EstimateStockLevelInputSchema },
    output: { schema: EstimateStockLevelOutputSchema },
    prompt: `You are an inventory management AI. Your task is to estimate the stock level of an item based on a photo. I will provide you with three examples of what "Full," "Low," and "Critical" stock looks like.

Here are your examples:
- This is an example of a **Full** stock level: {{media url="${fullStockUri}"}}
- This is an example of a **Low** stock level: {{media url="${lowStockUri}"}}
- This is an example of a **Critical** stock level: {{media url="${criticalStockUri}"}}

Now, analyze the following new image and classify its stock level based on the examples provided.
New image to analyze: {{media url=currentStockImageUri}}

Provide your analysis. Estimate the percentage full. If the level is Critical, the recommendation must be to reorder immediately. If it is Low, suggest adding it to the next reorder list.
`,
});

const estimateStockLevelFlow = ai.defineFlow(
  {
    name: 'estimateStockLevelFlow',
    inputSchema: EstimateStockLevelInputSchema,
    outputSchema: EstimateStockLevelOutputSchema,
  },
  async (input) => {
    const { output } = await prompt(input);
    if (!output) {
      throw new Error('The AI returned an unexpected response. Please try again.');
    }
    return output;
  }
);
